{
  "hash": "4cb19ea995decde01409231c4b1dfcb9",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"test\"\nsidebar: false\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nsource(\"~/R/OIID/topics/function.R\")\nlibrary(tidyverse, verbose = FALSE)\nlibrary(ggplot2)\nlibrary(lubridate)\nlibrary(rsdmx)\nlibrary(owidR)\nlibrary(reticulate)\nlibrary(gt)\nlibrary(scales, verbose = FALSE)\nlibrary(janitor)\nlibrary(shiny)\nlibrary(plotly)\nlibrary(ggiraph)\nlibrary(readr)  # For reading and writing CSV files\nlibrary(R.utils)  # For gzip compression\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nread_db <- function(id, dsd, path, version) {\n  \n  csv_path <- str_c(path, id, \".csv.gz\")\n  \n  if (file.exists(csv_path)) {\n    # If the compressed CSV file exists, read data from the file\n    df <- read_csv(csv_path)\n  } else {\n    # If the compressed CSV file does not exist, read data using readSDMX and save to compressed CSV\n    df <- readSDMX(\n        providerId = \"ISTAT\",\n        resource = \"data\", \n        flowRef = id,\n        dsd = dsd\n      ) %>% \n        as.data.frame(labels = TRUE)\n      \n      # Save data to CSV file and compress it\n      write_csv(df, str_c(path, id, \".csv\"))\n      gzip(str_c(path, id, \".csv\"), destname = csv_path, remove = TRUE)\n  }\n  \n  return(df)\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# List available resources. This will be in the backend to create the different datasets.\nresources <- readSDMX(providerId = \"ISTAT\", resource = \"dataflow\") %>% \n  as_tibble()\n```\n:::\n\n\n\n\n# Suicide time series\n\nTotal data for M and F.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# import suicide dataset\nsuicide <- read_db(\n  id = \"39_1005\",\n  dsd = TRUE,\n  path = \"~/R/OIID/topics/TEST/datasets/\",\n  version = \"1.0\"\n  )\n\nsuicide <- suicide %>% \n  mutate(year = ymd(str_c(obsTime, \"-01-01\"))) %>%\n  janitor::clean_names() %>%\n  rename(value = obs_value) %>%\n  select(year, matches(\"_it\"), value) %>% \n  rename(\n    sesso = sesso_label_it\n    )\n# plot suicide dataset \nsuicide_total <- suicide %>% \n  filter(\n    mod_suicidio_label_it == \"tutte le voci\" &\n      eta_label_it == \"totale\" &\n      paese_cittad_label_it == \"Italia\" &\n      istruzione_label_it == \"totale\" &\n      terr_res_label_it == \"Italia\" & # Totale\n      tipo_dato_label_it == \"morti\" &\n      sesso != \"totale\" &\n      stato_civ_label_it == \"totale\" &\n      malattie_fisiche_label_it == \"tutte le voci\" &\n      malattie_mentali_label_it == \"tutte le voci\" &\n      mese_decesso_label_it == \"anno\"\n  )\n\n# plot\nline_suicide <- ggplot(suicide_total) +\n  geom_line(aes(x = year, y = value, colour = sesso)) +\n  geom_point(aes(x = year, y = value, colour = sesso)) +\n  theme_classic() +\n  scale_color_brewer(palette = \"Dark2\") +\n  labs(\n    title = \"Time Series of Suicide\",\n    subtitle = \"By Year and Sex\",\n    x = \"Anni\",\n    y = \"Valore\",\n    color = \"Sesso\"\n  ) +\n  scale_x_date(breaks = pretty_breaks(n = 10)) +\n  scale_y_continuous(\n    breaks = pretty_breaks(n = 10),\n    labels = scales::number_format(big.mark = \",\")\n    )\nggplotly(line_suicide) %>% \n  layout(hovermode=\"x unified\")\n```\n:::\n\n\n\n\n# Felonies\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfelonies_db <- read_db(\n  id = \"73_58\",\n  dsd = TRUE,\n  path = \"~/R/OIID/topics/TEST/datasets/\",\n  version = \"1.4\"\n  )\n\nfelonies <- felonies_db %>%\n  mutate(year = ymd(str_c(obsTime, \"-01-01\"))) %>%\n  janitor::clean_names() %>%\n  rename(value = obs_value) %>%\n  select(year, matches(\"_it\"), value) %>% \n  rename_with(~ str_remove(.x, \"_label_it$\")) %>% \n  filter(\n    tipo_reato == \"delitti contro l'incolumità individuale\" |\n      tipo_reato %>% str_detect(\"omicidio\") |\n      tipo_reato %>% str_detect(\"violenza sessuale\") |\n      tipo_reato %>% str_detect(\"violenza privata\")\n    ) %>% \n  filter(\n    interv_reato_sent == \"totale\" &\n      eta_reato == \"totale\" &\n      eta_reatograve == \"totale\" &\n      distr_corteapp == \"tutti i distretti\" &\n      uff_giud == \"tutte le voci\" &\n      itter107 == \"Italia\" &\n      misure_sicur == \"tutte le voci\" &\n      natura_reato == \"tutte le voci\" &\n      precedenti == \"tutte le voci\" &\n      sesso != \"totale\" &\n      tipo_dato == \"numero di condannati per delitto con sentenza irrevocabile\" &\n      anno_reato == \"tutte le voci\"\n  )\n```\n:::\n\n\n\n\n::: panel-tabset\n## Total\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfelonies_total <- felonies %>% \n  summarise(\n    value = sum(value),\n    .by = c(year, sesso)\n  )\n# plot\nplot_time_series(\n  t = felonies_total,\n  x = felonies_total$year,\n  y = felonies_total$value,\n  colour = felonies_total$sesso,\n  palette = \"Dark2\",\n  title = \"Totale dei Reati\",\n  subtitle = \"Serie storica per sesso\",\n  xlabs = \"Anni\",\n  ylabs = \"Valore\",\n  legend_title = \"Sesso\"\n  )\n```\n:::\n\n\n\n\n## omicidio del consenziente consumato\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nomicidio_consenziente_consumato <- felonies %>% \n  filter(tipo_reato == \"omicidio del consenziente consumato\") %>% \n  summarise(\n    value = sum(value),\n    .by = c(year, sesso)\n  )\n# plot\nplot_time_series(\n  t = omicidio_consenziente_consumato,\n  x = omicidio_consenziente_consumato$year,\n  y = omicidio_consenziente_consumato$value,\n  colour = omicidio_consenziente_consumato$sesso,\n  palette = \"Dark2\",\n  title = \"Omicidio del consenziente consumato\",\n  subtitle = \"Serie storica per sesso\",\n  xlabs = \"Anni\",\n  ylabs = \"Valore\",\n  legend_title = \"Sesso\"\n  )\n```\n:::\n\n\n\n\n## Omicidio Colposo\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nomicidio_colposo <- felonies %>% \n  filter(tipo_reato == \"omicidio colposo\") %>% \n  summarise(\n    value = sum(value),\n    .by = c(year, sesso)\n  )\n# plot\nplot_time_series(\n  t = omicidio_colposo,\n  x = omicidio_colposo$year,\n  y = omicidio_colposo$value,\n  colour = omicidio_colposo$sesso,\n  palette = \"Dark2\",\n  title = \"Omicidio del consenziente consumato\",\n  subtitle = \"Serie storica per sesso\",\n  xlabs = \"Anni\",\n  ylabs = \"Valore\",\n  legend_title = \"Sesso\"\n  )\n```\n:::\n\n\n\n\n## Omicidio Volontario\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nomicidio_volontario <- felonies %>% \n  filter(tipo_reato == \"omicidio volontario\") %>% \n  summarise(\n    value = sum(value),\n    .by = c(year, sesso)\n  )\n# plot\nplot_time_series(\n  t = omicidio_volontario,\n  x = omicidio_volontario$year,\n  y = omicidio_volontario$value,\n  colour = omicidio_volontario$sesso,\n  palette = \"Dark2\",\n  title = \"Omicidio volontario\",\n  subtitle = \"Serie storica per sesso\",\n  xlabs = \"Anni\",\n  ylabs = \"Valore\",\n  legend_title = \"Sesso\"\n  )\n```\n:::\n\n\n\n\n## Omicidio Volontario Consumato\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nomicidio_volontario_consumato <- felonies %>% \n  filter(tipo_reato == \"omicidio volontario consumato\") %>% \n  summarise(\n    value = sum(value),\n    .by = c(year, sesso)\n  )\n# plot\nplot_time_series(\n  t = omicidio_volontario_consumato,\n  x = omicidio_volontario_consumato$year,\n  y = omicidio_volontario_consumato$value,\n  colour = omicidio_volontario_consumato$sesso,\n  palette = \"Dark2\",\n  title = \"Omicidio volontario consumato\",\n  subtitle = \"Serie storica per sesso\",\n  xlabs = \"Anni\",\n  ylabs = \"Valore\",\n  legend_title = \"Sesso\"\n  )\n```\n:::\n\n\n\n\n## Omicidio Volontario Tentato\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nomicidio_volontario_tentato <- felonies %>% \n  filter(tipo_reato == \"omicidio volontario tentato\") %>% \n  summarise(\n    value = sum(value),\n    .by = c(year, sesso)\n  )\n# plot\nplot_time_series(\n  t = omicidio_volontario_tentato,\n  x = omicidio_volontario_tentato$year,\n  y = omicidio_volontario_tentato$value,\n  colour = omicidio_volontario_tentato$sesso,\n  palette = \"Dark2\",\n  title = \"Omicidio volontario tentato\",\n  subtitle = \"Serie storica per sesso\",\n  xlabs = \"Anni\",\n  ylabs = \"Valore\",\n  legend_title = \"Sesso\"\n  )\n```\n:::\n\n\n\n\n## Omicidio Preterintenzionale\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nomicidio_volontario_preterintenzionale <- felonies %>% \n  filter(tipo_reato == \"omicidio volontario preterintenzionale\") %>% \n  summarise(\n    value = sum(value),\n    .by = c(year, sesso)\n  )\n# plot\nplot_time_series(\n  t = omicidio_volontario_preterintenzionale,\n  x = omicidio_volontario_preterintenzionale$year,\n  y = omicidio_volontario_preterintenzionale$value,\n  colour = omicidio_volontario_preterintenzionale$sesso,\n  palette = \"Dark2\",\n  title = \"Omicidio volontario preterintenzionale\",\n  subtitle = \"Serie storica per sesso\",\n  xlabs = \"Anni\",\n  ylabs = \"Valore\",\n  legend_title = \"Sesso\"\n  )\n```\n:::\n\n\n\n\n## Violenza Privata Tentata\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nviolenza_privata_tentata <- felonies %>% \n  filter(tipo_reato == \"violenza privata tentata\") %>% \n  summarise(\n    value = sum(value),\n    .by = c(year, sesso)\n  )\n# plot\nplot_time_series(\n  t = violenza_privata_tentata,\n  x = violenza_privata_tentata$year,\n  y = violenza_privata_tentata$value,\n  colour = violenza_privata_tentata$sesso,\n  palette = \"Dark2\",\n  title = \"Violenza Privata Tentata\",\n  subtitle = \"Serie storica per sesso\",\n  xlabs = \"Anni\",\n  ylabs = \"Valore\",\n  legend_title = \"Sesso\"\n  )\n```\n:::\n\n\n\n\n## Violenza Privata\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nviolenza_privata <- felonies %>% \n  filter(tipo_reato == \"violenza privata\") %>% \n  summarise(\n    value = sum(value),\n    .by = c(year, sesso)\n  )\n# plot\nplot_time_series(\n  t = violenza_privata,\n  x = violenza_privata$year,\n  y = violenza_privata$value,\n  colour = violenza_privata$sesso,\n  palette = \"Dark2\",\n  title = \"Violenza Privata\",\n  subtitle = \"Serie storica per sesso\",\n  xlabs = \"Anni\",\n  ylabs = \"Valore\",\n  legend_title = \"Sesso\"\n  )\n```\n:::\n\n\n\n\n## Violenza Sessuale di Gruppo\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nviolenza_sessuale_gruppo <- felonies %>% \n  filter(tipo_reato == \"violenza sessuale di gruppo\") %>% \n  summarise(\n    value = sum(value),\n    .by = c(year, sesso)\n  )\n# plot\nplot_time_series(\n  t = violenza_sessuale_gruppo,\n  x = violenza_sessuale_gruppo$year,\n  y = violenza_sessuale_gruppo$value,\n  colour = violenza_sessuale_gruppo$sesso,\n  palette = \"Dark2\",\n  title = \"Violenza Sessuale di Gruppo\",\n  subtitle = \"Serie storica per sesso\",\n  xlabs = \"Anni\",\n  ylabs = \"Valore\",\n  legend_title = \"Sesso\"\n  )\n```\n:::\n\n\n\n\n## Violenza Sessuale\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nviolenza_sessuale <- felonies %>% \n  filter(tipo_reato == \"violenza sessuale\") %>% \n  summarise(\n    value = sum(value),\n    .by = c(year, sesso)\n  )\n# plot\nplot_time_series(\n  t = violenza_sessuale,\n  x = violenza_sessuale$year,\n  y = violenza_sessuale$value,\n  colour = violenza_sessuale$sesso,\n  palette = \"Dark2\",\n  title = \"Violenza Sessuale\",\n  subtitle = \"Serie storica per sesso\",\n  xlabs = \"Anni\",\n  ylabs = \"Valore\",\n  legend_title = \"Sesso\"\n  )\n```\n:::\n\n\n\n:::\n\n# Population\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npopulation <- read_db(\n  id = \"52_1194\",\n  dsd = TRUE,\n  path = \"~/R/OIID/topics/TEST/datasets/\",\n  version = \"1.5\"\n  )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npopulation <- population %>% \n  mutate(year = ymd(str_c(obsTime, \"-01-01\"))) %>%\n  janitor::clean_names() %>%\n  rename(value = obs_value) %>%\n  select(year, matches(\"_it\"), value) %>% \n  rename_with(~ str_remove(.x, \"_label_it$\"))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npopulation_total <- population %>% \n  filter(\n    itter107 == \"Italia\" &\n      sesso != \"totale\" &\n      cittadinanza == \"totale\" &\n      titolo_studio == \"totale\" &\n      (classe_eta == \"15-64 anni\" | classe_eta == \"65 anni e più\")\n  ) %>% \n  summarise(\n    sum = sum(value) * 1000,\n    .by = c(year, sesso)\n  ) %>% \n  filter(!is.na(year))\n\nline_population <- ggplot(population_total) +\n  geom_line(aes(x = year, y = sum, colour = sesso)) +\n  geom_point(aes(x = year, y = sum, colour = sesso, text = paste(\"Year: \", year, \"<br>Sum: \", scales::comma(sum)))) +\n  theme_classic() +\n  scale_color_brewer(palette = \"Dark2\") +\n  labs(\n    title = \"Time Series of Suicide\",\n    subtitle = \"By Year and Sex\",\n    x = \"Anni\",\n    y = \"Valore\",\n    color = \"Sesso\"\n  ) +\n  scale_x_continuous(breaks = pretty_breaks(n = 10)) +\n  scale_y_continuous(\n    breaks = pretty_breaks(n = 10),\n    labels = scales::comma\n  )\n\nplot <- ggplotly(line_population, tooltip = c(\"text\")) %>% \n  layout(hovermode = \"x unified\")\n\nplot\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}